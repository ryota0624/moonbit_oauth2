name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      dry-run:
        description: "Dry run (no actual changes)"
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  # Create or update release PR on every push to main
  # Skipped when the push is a release commit (handled by release job)
  release-pr:
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && !(startsWith(github.event.head_commit.message, 'chore:') && contains(github.event.head_commit.message, 'release v')))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup MoonBit
        run: |
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> $GITHUB_PATH

      - name: Fetch dependencies
        run: moon update

      - name: Install moon-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -fsSL https://raw.githubusercontent.com/dijdzv/moon-release/main/install.sh | bash -s -- 0.3
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create Release PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ github.event.inputs.dry-run }}
        run: |
          DRY_RUN_FLAG=""
          if [ "$DRY_RUN" = "true" ]; then
            DRY_RUN_FLAG="--dry-run"
          fi
          moon-release release-pr $DRY_RUN_FLAG --verbose

  # Create release after release PR is merged
  release:
    if: github.event_name == 'push' && startsWith(github.event.head_commit.message, 'chore:') && contains(github.event.head_commit.message, 'release v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup MoonBit
        run: |
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> $GITHUB_PATH

      - name: Fetch dependencies
        run: moon update

      - name: Install dependencies
        run: moon install

      # Pre-release verification
      - name: Run unit tests (Native)
        run: moon test --target native

      - name: Run unit tests (JS)
        run: moon test --target js

      - name: Check code formatting
        run: moon fmt --check

      - name: Type check
        run: moon check

      - name: Build packages (Native)
        run: |
          moon build --target native lib/oauth2
          moon build --target native lib/oidc

      - name: Build packages (JS)
        run: |
          moon build --target js lib/oauth2
          moon build --target js lib/oidc

      - name: Verify package structure
        run: |
          echo "Checking OAuth2 package..."
          test -f lib/oauth2/moon.pkg || (echo "lib/oauth2/moon.pkg not found" && exit 1)

          echo "Checking OIDC package..."
          test -f lib/oidc/moon.pkg || (echo "lib/oidc/moon.pkg not found" && exit 1)

          echo "Checking generated interfaces..."
          test -f lib/oauth2/pkg.generated.mbti || (echo "lib/oauth2/pkg.generated.mbti not found" && exit 1)
          test -f lib/oidc/pkg.generated.mbti || (echo "lib/oidc/pkg.generated.mbti not found" && exit 1)

          echo "âœ“ Package structure verified"

      # Release process
      - name: Install moon-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -fsSL https://raw.githubusercontent.com/dijdzv/moon-release/main/install.sh | bash -s -- 0.3
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # Configure mooncakes credentials (skip if no token configured)
      - name: Setup mooncakes credentials
        env:
          MOONCAKES_TOKEN: ${{ secrets.MOONCAKES_TOKEN }}
          MOONCAKES_USERNAME: ${{ secrets.MOONCAKES_USERNAME }}
        run: |
          if [ -z "$MOONCAKES_TOKEN" ]; then
            echo "No mooncakes token configured, skipping credentials setup"
            exit 0
          fi
          mkdir -p ~/.moon
          jq -n --arg token "$MOONCAKES_TOKEN" --arg username "$MOONCAKES_USERNAME" \
            '{"token": $token, "username": $username}' > ~/.moon/credentials.json
          chmod 600 ~/.moon/credentials.json

      - name: Create release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: moon-release release --verbose

      - name: Show release info
        run: |
          echo "ðŸ“¦ Released packages:"
          echo "  - ryota0624/oauth2/oauth2 (OAuth2 client library)"
          echo "  - ryota0624/oauth2/oidc (OpenID Connect support)"
          echo ""
          echo "Directory structure:"
          echo "  lib/oauth2/ - OAuth2 implementation"
          echo "  lib/oidc/   - OIDC implementation"
